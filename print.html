<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A Thorough Guide to Deploying Compound Protocol</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="getting-started/index.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting-started/installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="getting-started/configuration.html"><strong aria-hidden="true">2.2.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="getting-started/script.html"><strong aria-hidden="true">2.3.</strong> Automate Setup via Script</a></li></ol></li><li class="chapter-item expanded "><a href="build-compound.html"><strong aria-hidden="true">3.</strong> Building Compound Protocol</a></li><li class="chapter-item expanded "><a href="deploy-compound/index.html"><strong aria-hidden="true">4.</strong> Deploying Compound Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deploy-compound/deploy-via-eureka.html"><strong aria-hidden="true">4.1.</strong> Deploying via Eureka</a></li><li class="chapter-item expanded "><a href="deploy-compound/alternate-testnets.html"><strong aria-hidden="true">4.2.</strong> Deploying to Alternate Testnets (e.g. Rinkeby)</a></li><li class="chapter-item expanded "><a href="deploy-compound/tips.html"><strong aria-hidden="true">4.3.</strong> Tips</a></li></ol></li><li class="chapter-item expanded "><a href="under-the-hood/index.html"><strong aria-hidden="true">5.</strong> Under the Hood</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="under-the-hood/core.html"><strong aria-hidden="true">5.1.</strong> Compound Core</a></li><li class="chapter-item expanded "><a href="under-the-hood/governance.html"><strong aria-hidden="true">5.2.</strong> Compound Core + Governance</a></li></ol></li><li class="chapter-item expanded "><a href="troubleshooting/index.html"><strong aria-hidden="true">6.</strong> Troubleshooting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="troubleshooting/compound-protocol.html"><strong aria-hidden="true">6.1.</strong> compound-protocol</a></li><li class="chapter-item expanded "><a href="troubleshooting/compound-eureka.html"><strong aria-hidden="true">6.2.</strong> compound-eureka</a></li></ol></li><li class="chapter-item expanded "><a href="credits.html"><strong aria-hidden="true">7.</strong> Credits</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A Thorough Guide to Deploying Compound Protocol</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><img src="./img/compound-comp-logo.png" alt="Compound Logo" /></p>
<p>This is a thorough guide to everything related to deploying Compound protocol to an Ethereum network, such as a public testnet (e.g. Rinkeby, Ropsten). Compiling the Compound protocol contracts, deploying the Compound protocol contracts, and any information that is not obvious to at first glance to a newcomer to the Compound protocol repositories will be addressed in this guide.</p>
<p>This guide is written for the <a href="https://github.com/compound-finance/compound-protocol"><code>compound-protocol</code></a> and the <a href="https://github.com/compound-finance/compound-eureka"><code>compound-eureka</code></a> GitHub repositories' master branches as of writing. Therefore, we will be referring to the following commits for each repository:</p>
<ul>
<li><code>compound-protocol</code>: <a href="https://github.com/compound-finance/compound-protocol/tree/a6251ecc30adb8dfa904e2231e9a9fdb4eea78be">a6251ecc30adb8dfa904e2231e9a9fdb4eea78be</a></li>
<li><code>compound-eureka</code>: <a href="https://github.com/compound-finance/compound-eureka/tree/4c58f3bfdd08c74926f0c0e0c0f2eabac78b8b83">4c58f3bfdd08c74926f0c0e0c0f2eabac78b8b83</a></li>
</ul>
<h2 id="on-the-guide"><a class="header" href="#on-the-guide">On the Guide</a></h2>
<p>This guide assumes an installation of a modern Debian distribution: specifically, this guide has been written testing Ubuntu Linux 20.04 LTS. This guide will work similarly for other UNIX-like operating systems (e.g. Arch, macOS), but will require some knowledge of the system's package manager and other specifics.</p>
<h2 id="compound-protocol"><a class="header" href="#compound-protocol">Compound Protocol</a></h2>
<p>Compound is a decentralized protocol which establishes pools of assets with algorithmically-calculated interest rates, allowing for the supplying and borrowing of assets. If you do not know very much about Compound, check out the <a href="https://compound.finance/documents/Compound.Whitepaper.pdf">Compound Whitepaper</a> and the <a href="https://github.com/compound-finance/compound-protocol/tree/master/docs/CompoundProtocol.pdf">Compound Protocol Specification</a> to learn more.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Node 13.x, <code>npm</code>, <code>yarn</code>, <code>solc</code> v0.5.16, <code>git</code>, <code>python</code>, <code>g++</code>, and <code>make</code> are all needed to be installed on the system before using either repository. With the exception of the Node.js-specific tooling, many of these should be available on a basic Linux installation out of the box.</p>
<p><code>libusb</code> and <code>libudev</code> are also required for the <code>compound-protocol</code> repo.</p>
<p>Note that if you have a newer version of <code>solc</code>, you will need to install the older version to build Compound protocol contracts.</p>
<p>We will be providing instructions on how to install most of these dependencies below, so don't worry!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="installing-via-apt"><a class="header" href="#installing-via-apt">Installing via apt</a></h2>
<p>First, let's refresh our package list:</p>
<pre><code class="language-sh">sudo apt-get update
</code></pre>
<p>Next, install each of the following, as needed:</p>
<h3 id="make"><a class="header" href="#make">make</a></h3>
<pre><code class="language-sh">sudo apt-get install -y make
</code></pre>
<h3 id="libusb-and-libudev"><a class="header" href="#libusb-and-libudev">libusb and libudev</a></h3>
<pre><code class="language-sh">sudo apt-get install -y libusb-1.0-0-dev libudev-dev
</code></pre>
<h3 id="node-13x"><a class="header" href="#node-13x">Node 13.x</a></h3>
<pre><code class="language-sh">curl -fsSL https://deb.nodesource.com/setup_13.x | sudo -E bash -
sudo apt-get install -y nodejs
</code></pre>
<h3 id="yarn"><a class="header" href="#yarn">yarn</a></h3>
<pre><code class="language-sh">npm install --global yarn
</code></pre>
<h3 id="solc-v0516"><a class="header" href="#solc-v0516">solc v0.5.16</a></h3>
<pre><code class="language-sh">sudo wget https://github.com/ethereum/solidity/releases/download/v0.5.16/solc-static-linux -O /usr/local/bin/solc
sudo chmod +x /usr/local/bin/solc
</code></pre>
<h2 id="verifying-correct-packages"><a class="header" href="#verifying-correct-packages">Verifying Correct Packages</a></h2>
<p>After installing, it may help to verify that your packages have installed correctly. Try running <code>node -v</code> and <code>solc --version</code>, and check to see if their versions match.</p>
<p>Here is an example of output for correctly installed Node v13.x:</p>
<pre><code class="language-sh">root@ubuntu-s-2vcpu-4gb-intel-tor1-01:~# node -v
v13.14.0
</code></pre>
<p>Note: It's fine if your installation doesn't have matching minor versions or patch versions: as long as the major version is 13, i.e. <code>v13.x.x</code>, the installation is correct.</p>
<p>And example output for correctly installed solc v0.5.16:</p>
<pre><code class="language-sh">root@ubuntu-s-2vcpu-4gb-intel-tor1-01:~# solc --version
solc, the solidity compiler commandline interface
Version: 0.5.16+commit.9c3226ce.Linux.g++
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p><code>compound-protocol</code> and <code>compound-eureka</code> require a private key for any deployment-related scripts, and an Etherscan API key, if you'd like to verify those deployed contracts on Etherscan. Luckily, the configuration for both are very similar.</p>
<h2 id="private-key"><a class="header" href="#private-key">Private Key</a></h2>
<p>For setting a private key to run transactions from, you have two options:</p>
<ol>
<li>Save the private key in a file named after the network within <code>~/ethereum</code></li>
<li>Pass the <code>ACCOUNT</code>/<code>pk</code> environment variable to the command</li>
</ol>
<p>I recommend stashing the private key in a file. For example, to save a private key <code>80bbfb503fb22fc4de19bac1e42cbd5983d8ed26b5c04884b142e6ddf6140eef</code> for usage for the Ropsten network, one may run:</p>
<pre><code class="language-sh">mkdir -p ~/.ethereum
echo '80bbfb503fb22fc4de19bac1e42cbd5983d8ed26b5c04884b142e6ddf6140eef' &gt; ~/.ethereum/ropsten
</code></pre>
<h2 id="etherscan-api-key"><a class="header" href="#etherscan-api-key">Etherscan API Key</a></h2>
<p>To have the script verify a contract on Etherscan after deployment, the API key must be passed through an environment variable. I suggest stashing the API key in your <code>~/.bashrc</code> and referring to it from there. For example, to save an API key <code>7C0WA5ES3176894W6APLTH0K9T6S0M1V3F</code>, one may run:</p>
<pre><code class="language-sh">echo -e '\nETHERSCAN_API_KEY=7C0WA5ES3176894W6APLTH0K9T6S0M1V3F' &gt;&gt; ~/.bashrc
</code></pre>
<p>Don't forget to run <code>. ~/.bashrc</code> to reload our new configuration into the current shell environment!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="automate-setup-via-script"><a class="header" href="#automate-setup-via-script">Automate Setup via Script</a></h1>
<p>If you would like to automate the installation of required packages, configuration, and initial setup of both Compound protocol repositories, you may use the <code>compound-setup.sh</code> script located <a href="https://raw.githubusercontent.com/Luiserebii/compound-protocol-docs/master/files/compound-setup.sh">here</a>. This may especially be useful if you are installing to a fresh system, like a newly installed Ubuntu 20.04 LTS VPS.</p>
<p>This script will perform the following:</p>
<ul>
<li>Install all dependencies as listed in <a href="getting-started/./installation.html">Installation</a></li>
<li>Save the given private key in both <code>~/.ethereum/ropsten</code> and <code>~/.ethereum/rinkeby</code></li>
<li>Save the Etherscan API key in <code>~/.bashrc</code> as <code>ETHERSCAN_API_KEY</code></li>
<li>Clone <code>compound-protocol</code> to the home directory <code>~/</code> and install all dependencies</li>
<li>Clone <code>compound-eureka</code> to the home directory <code>~/</code> and install all dependencies</li>
</ul>
<p>If you use this script, don't forget to reload the shell environment with <code>. ~/.bashrc</code>!</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>Simply download the script, give it the proper permissions, and run it, using <code>-p</code> to pass the private key for deployment, and <code>-e</code> to pass the Etherscan API key. For example, if <code>80bbfb503fb22fc4de19bac1e42cbd5983d8ed26b5c04884b142e6ddf6140eef</code> is the private key you'd like to setup, and <code>7C0WA5ES3176894W6APLTH0K9T6S0M1V3F</code> is the Etherscan API key you'd like to use, you would run:</p>
<pre><code class="language-sh">wget https://raw.githubusercontent.com/Luiserebii/compound-protocol-docs/master/files/compound-setup.sh
chmod 755 compound-setup.sh
./compound-setup.sh -p 80bbfb503fb22fc4de19bac1e42cbd5983d8ed26b5c04884b142e6ddf6140eef -e 7C0WA5ES3176894W6APLTH0K9T6S0M1V3F
. ~/.bashrc
</code></pre>
<script id="asciicast-oyiLT6TaHzXWpoFGPAR7Q18lA" src="https://asciinema.org/a/oyiLT6TaHzXWpoFGPAR7Q18lA.js" async data-autoplay="true"></script>
<h5 id="downloading-and-running-setup-script-on-a-fresh-ubuntu-linux-2004-lts-machine"><a class="header" href="#downloading-and-running-setup-script-on-a-fresh-ubuntu-linux-2004-lts-machine">Downloading and running setup script on a fresh Ubuntu Linux 20.04 LTS machine</a></h5>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-compound-protocol"><a class="header" href="#building-compound-protocol">Building Compound Protocol</a></h1>
<p>If you are looking to deploy a specific or modified version of the Compound protocol, this section will address the building process of the official Compound protocol repository! Note that Compound Eureka (the Compound deployment scripts) already have built versions of Compound committed into the repository, so this section can be skipped.</p>
<h2 id="initial-setup"><a class="header" href="#initial-setup">Initial setup</a></h2>
<p>First, let's clone the GitHub repository and install all needed dependencies:</p>
<pre><code class="language-sh">git clone https://github.com/compound-finance/compound-protocol
cd compound-protocol
yarn install --lock-file
</code></pre>
<h2 id="compiling"><a class="header" href="#compiling">Compiling</a></h2>
<p>Compiling is simple:</p>
<pre><code class="language-sh">yarn compile
</code></pre>
<script id="asciicast-KKD6834A608k84sb0aqyHILm9" src="https://asciinema.org/a/KKD6834A608k84sb0aqyHILm9.js" async data-autoplay="true"></script>
<h5 id="compilation-output-on-an-ubuntu-linux-2004-lts-machine"><a class="header" href="#compilation-output-on-an-ubuntu-linux-2004-lts-machine">Compilation output on an Ubuntu Linux 20.04 LTS machine</a></h5>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>If you would like to test the contracts, you may run <code>yarn test</code>, but note that it may take a while to run all of them. The following output was received after running all tests, taking a little over an hour:</p>
<pre><code>Test Suites: 2 skipped, 99 passed, 99 of 101 total
Tests:       46 skipped, 15 todo, 1074 passed, 1135 total
Snapshots:   0 total
Time:        3927.308s
Ran all test suites matching /test/i.
Teardown in 0 ms
Done in 3951.43s.
</code></pre>
<p>It may be useful to know that the <a href="https://app.circleci.com/pipelines/github/compound-finance/compound-protocol/498/workflows/32845109-0390-4d92-b8c8-b8492a3adaff/jobs/2190"><code>compound-protocol</code> CircleCI</a> only runs a portion of these tests, which expands to:</p>
<pre><code class="language-sh">yarn test tests/CompilerTest.js tests/Comptroller/assetsListTest.js tests/Comptroller/pauseGuardianTest.js tests/Flywheel/FlywheelTest.js tests/Governance/CompScenarioTest.js tests/Governance/GovernorAlpha/ProposeTest.js tests/Governance/GovernorBravo/CastVoteTest.js tests/Governance/GovernorBravo/StateTest.js tests/Models/DAIInterestRateModelTest.js tests/SpinaramaTest.js tests/Tokens/adminTest.js tests/Tokens/cTokenTest.js tests/Tokens/mintAndRedeemCEtherTest.js tests/Tokens/safeTokenTest.js tests/Tokens/transferTest.js
</code></pre>
<p>This may be a shorter subset that allows for easier testing. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploying-compound-protocol"><a class="header" href="#deploying-compound-protocol">Deploying Compound Protocol</a></h1>
<p><code>compound-eureka</code> uses Eureka (<a href="https://www.npmjs.com/package/@compound-finance/eureka/v/1.0.3">@compound-finance/eureka</a>) to author the smart contract deployment description, logic, and flow. Through passing <code>.eureka</code> files stored in the <code>./eureka</code> directory to <code>yarn eureka apply</code>, we can specify which parts of the protocol we'd like to deploy. For more on Eureka, see the README.md documenation included with the npm package.</p>
<p>As <code>compound-eureka</code> includes many different <code>.eureka</code> files, I would suggest looking at the <a href="https://github.com/compound-finance/compound-eureka">README.md</a> to see the range of configurations available to you. As it would too exhaustive to use all of them for this guide, we will only be covering <code>eureka/compound.eureka</code>, <code>eureka/testnet.eureka</code>, and <code>eureka/testnet-gov.eureka</code>.</p>
<h2 id="on-eureka"><a class="header" href="#on-eureka">On <code>.eureka</code></a></h2>
<p>One peering over the <code>.eureka</code> files (such as <code>eureka/compound.eureka</code>) will notice that some contracts have a string within square brackets (<code>[]</code>). Although this is undocumented, I believe it refers to the name of the <code>.json</code> file blob to refer to within the <code>.build</code> folder, which appears to have the contract ABI and pre-compiled bytecode built in. For example, <code>[b73e68c]</code> looks for the named contract within <code>.build/b73e68c.json</code>.</p>
<h2 id="deploying-a-custom-build"><a class="header" href="#deploying-a-custom-build">Deploying a Custom Build</a></h2>
<p>If you are looking to use a custom build of Compound, you will want to note that you will likely have to make a copy of the appropriate <code>.eureka</code> file and modify them to refer to your built <code>.json</code>. If you've built using <code>compound-protocol</code>, you can find this within the <code>.build</code> folder as <code>.build/contracts.json</code>.</p>
<p><code>./fetch_build.sh</code> is unfortunately broken, as there appear to be no docker builds of <code>compound-protocol</code> at the link in the repository. The script does not do more than compiling and saving the the contents of the built <code>.build/contracts.json</code> into a new renamed file (e.g. <code>.build/8bc065b.json</code>), so if you will have to checkout the commit, build, and copy/rename the file into eureka's <code>.build</code> manually.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploying-via-eureka"><a class="header" href="#deploying-via-eureka">Deploying via Eureka</a></h1>
<h2 id="initial-setup-1"><a class="header" href="#initial-setup-1">Initial Setup</a></h2>
<p>First, let's clone the GitHub repository and install all needed dependencies:</p>
<pre><code class="language-sh">git clone https://github.com/compound-finance/compound-eureka/
cd compound-eureka
yarn install
</code></pre>
<h2 id="deploying-compound-protocol-1"><a class="header" href="#deploying-compound-protocol-1">Deploying Compound Protocol</a></h2>
<p>To deploy our Compound protocol smart contracts, we will be using the script <code>yarn eureka apply</code>, specifying the network, build folder, config files, and eureka spec files. In order to verify deployed contracts via Etherscan, we specify the Etherscan API key through a passed <code>etherscan</code> environment variable. In this section, we will be writing the commands assuming the <code>ETHERSCAN_API_KEY</code> environment variable has been set up the way described in <a href="deploy-compound/../getting-started/configuration.html#etherscan-api-key">Getting Started</a>.</p>
<p>We will be using the Ropsten test network, although we will later discuss how to get deployment working on other popular testnets, like Rinkeby.</p>
<h3 id="initial-clean"><a class="header" href="#initial-clean">Initial Clean</a></h3>
<p>A freshly cloned repository will already have deployment state saved, which cause Eureka to not execute a fresh deployment, processing any deployments under the pre-existing deployment data instead. Therefore, first clean the deployment state by running:</p>
<pre><code class="language-sh">yarn eureka clean -n ropsten -c config/*.js
</code></pre>
<p>For more on <code>yarn eureka clean</code>, see the section on <a href="deploy-compound/./tips.html#cleaning-deployment-state">Cleaning Deployment State</a>.</p>
<h3 id="running-the-deployment"><a class="header" href="#running-the-deployment">Running the Deployment</a></h3>
<p>Through specifying the Etherscan API key, the network as Ropsten, and the appropriate config, build, and eureka filepaths, we create a command that deploys core Compound protocol smart contracts to Ropsten:</p>
<pre><code class="language-sh">etherscan=$ETHERSCAN_API_KEY yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet}.eureka
</code></pre>
<p>Deploying governance contracts with the core is as simple as adding <code>testnet-gov.eureka</code> to our list:</p>
<pre><code class="language-sh">etherscan=$ETHERSCAN_API_KEY yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet,testnet-gov}.eureka
</code></pre>
<script id="asciicast-bQ7Si8tPufmgpa1THC6up0o7k" src="https://asciinema.org/a/bQ7Si8tPufmgpa1THC6up0o7k.js" async></script>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploying-to-alternate-testnets-eg-rinkeby"><a class="header" href="#deploying-to-alternate-testnets-eg-rinkeby">Deploying to Alternate Testnets (e.g. Rinkeby)</a></h1>
<p>To deploy to an alternate testnet, like Rinkeby, we have to be a little creative. Attempting to run <code>yarn eureka apply -n rinkeby ...</code> produces a deployment that appears to break because the emitted transactions are run out of order, suggesting it is undocumented for a reason.</p>
<p>However, we have a working deployment setup for the <code>-n ropsten</code> switch! So, by modifying the switch to run all transactions and verify contracts on the Rinkeby network instead, we can accomplish a successful deployment to Rinkeby. Thus, our job changes to ensuring that transactions running off of the <code>-n ropsten</code> switch pass through a Rinkeby provider, and that transactions are verified off of the Rinkeby network when interfacing with Etherscan.</p>
<p>Thankfully, <code>yarn eureka apply</code> checks for a <code>provider</code> environment variable, which will override the provider set! Thus, for Rinkeby, we may pass <code>provider=https://rinkeby-eth.compound.finance</code>. </p>
<p>What about verifying contracts on Etherscan under the right network? Our solution for this is a little dirtier, and involves modifying Eureka itself. Open the file <code>./node_modules/@compound-finance/eureka/src/actor.mjs</code> for editing, browse to lines 264-298, and look at the function <code>doVerify</code>:</p>
<pre><code class="language-js">  async function doVerify(contract, address, args, contractJson, constructorData) {
    if (!ethereum.verificationOpts.etherscanApiKey) {
      throw new Error(`Cannot verify contract without Etherscan API Key`);
    }

    let funcInfo = showFunc(contract, 'constructor', args);

    if (dryRun) {
      log(`[Dry run] Verifying contract ${contract} at ${address} with ${funcInfo}`);
      return;
    }

    try {
      log(`Verifying contract ${contract} at ${address} with ${funcInfo}`);

      let {
        verified,
        url,
        alreadyVerified
      } = await Etherscan.verifyContract(contractJson, ethereum.network, ethereum.verificationOpts.etherscanApiKey, address, constructorData, verbose);

      if (!verified) {
        throw new Error(`Failed to verify contract ${contract}`);
      }

      if (alreadyVerified) {
        log(`Contract ${contract} already verified at ${url}`);
      } else {
        log(`Contract ${contract} verified on Etherscan at ${url}`);
      }
    } catch (e) {
      logError(`Error verifying \`${funcInfo}\`: ${e.toString()}`);
      throw e;
    }
  }
</code></pre>
<p>What we want to target is the argument being passed <code>ethereum.network</code> to the <code>await Etherscan.verifyContract()</code> call, and hardcode it to our target testnet (in this case, Rinkeby). Therefore, to hardcode it to Rinkeby, we might modify line 283 like so:</p>
<pre><code class="language-js">  async function doVerify(contract, address, args, contractJson, constructorData) {
    if (!ethereum.verificationOpts.etherscanApiKey) {
      throw new Error(`Cannot verify contract without Etherscan API Key`);
    }

    let funcInfo = showFunc(contract, 'constructor', args);

    if (dryRun) {
      log(`[Dry run] Verifying contract ${contract} at ${address} with ${funcInfo}`);
      return;
    }

    try {
      log(`Verifying contract ${contract} at ${address} with ${funcInfo}`);

      let {
        verified,
        url,
        alreadyVerified
      } = await Etherscan.verifyContract(contractJson, 'rinkeby', ethereum.verificationOpts.etherscanApiKey, address, constructorData, verbose); // Hardcoding to 'rinkeby'

      if (!verified) {
        throw new Error(`Failed to verify contract ${contract}`);
      }

      if (alreadyVerified) {
        log(`Contract ${contract} already verified at ${url}`);
      } else {
        log(`Contract ${contract} verified on Etherscan at ${url}`);
      }
    } catch (e) {
      logError(`Error verifying \`${funcInfo}\`: ${e.toString()}`);
      throw e;
    }
  }
</code></pre>
<p>Save the file, and all verifications should now run for Rinkeby. Finally, we run the deployment commands in much the same way as both, just with the <code>provider</code> included. Deploying just the core Compound contracts is thus:</p>
<pre><code class="language-sh">etherscan=$ETHERSCAN_API_KEY provider=https://rinkeby-eth.compound.finance yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet}.eureka
</code></pre>
<p>And with governance included:</p>
<pre><code class="language-sh">etherscan=$ETHERSCAN_API_KEY provider=https://rinkeby-eth.compound.finance yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet,testnet-gov}.eureka
</code></pre>
<p>It is important to note, of course, that the private key saved at <code>~/.ethereum/ropsten</code> will be used, not the one at <code>~/.ethereum/rinkeby</code>!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tips"><a class="header" href="#tips">Tips</a></h1>
<h2 id="cleaning-deployment-state"><a class="header" href="#cleaning-deployment-state">Cleaning Deployment State</a></h2>
<p>Eureka saves deployment state data on newly deployed contracts to a file. Running <code>yarn eureka clean</code> is useful for wiping this state and ensuring that a new deployment is clean. If you are looking to deploy all of Compound protocol again, you will need to clear the state!</p>
<p>The general syntax of the command is:</p>
<pre><code class="language-sh">yarn eureka clean -n network -c config/*.js
</code></pre>
<p>where network is substituted for the name of the network. For example, to clean the deployment state for Ropsten, run:</p>
<pre><code class="language-sh">yarn eureka clean -n ropsten -c config/*.js
</code></pre>
<p><strong>NOTE</strong>: Why don't we add the <code>-b</code> switch if the <code>compound-eureka</code> documentation includes it?</p>
<p>The answer: if we look at what <code>yarn eureka clean</code> runs, we see that the <code>-b</code> switch is not read at all. Following the chain of execution, within <code>package.json</code>, lines 6-9:</p>
<pre><code class="language-js">  &quot;scripts&quot;: {
    &quot;eureka&quot;: &quot;node --experimental-vm-modules --unhandled-rejections=strict node_modules/@compound-finance/eureka/src/cli.mjs&quot;,
    &quot;import-contract&quot;: &quot;node --experimental-vm-modules --unhandled-rejections=strict ./import_contract.mjs&quot;
  },
</code></pre>
<p>And then, into <code>node_modules/@compound-finance/eureka/src/cli.mjs</code>, lines 40-43:</p>
<pre><code class="language-js">    .command('clean', 'deletes Eureka backend state', (yargs) =&gt; {
      }, async (argv) =&gt; {
        cleanBackend(argv.network, array(argv.config_file), argv.yes, argv.verbose, argv.jsonrpc);
      })
</code></pre>
<p>From this, we can see that only the network (<code>-n</code>) and config (<code>-c</code>) switches are really read.</p>
<h2 id="increasing-gas-price"><a class="header" href="#increasing-gas-price">Increasing Gas Price</a></h2>
<p>By default, Eureka will run all transactions with a gas price of 1 Gwei. This might be useful to increase if you'd like to speed up the deployment process, either for convenience, or to resolve an error.</p>
<p>We can accomplish this in a dirty way by directly modifying Eureka. Open the file located at <code>./node_modules/@compound-finance/eureka/src/ethereum.mjs</code> for editing, and within lines 207-218, look at the function there:</p>
<pre><code class="language-js">export async function dispatch({ eth, provider, from, gas, gasPrice }, contract, data) {
  return await eth.sendTransaction({
    from,
    to: contract,
    value: 0,
    gas,
    gasPrice,
    data: data
  }).on('transactionHash', (hash) =&gt; {
    console.log(`Running Ethereum Trx: ${hash}`);
  });
}
</code></pre>
<p>We want to hardcode the <code>gasPrice</code> variable. For example, if we were to hardcode it to 7 Gwei, we might modify the <code>gasPrice</code> line (line 213) like so:</p>
<pre><code class="language-js">export async function dispatch({ eth, provider, from, gas, gasPrice }, contract, data) {
  return await eth.sendTransaction({
    from,
    to: contract,
    value: 0,
    gas,
    gasPrice: '7000000000', // Hardcoding to 7 Gwei
    data: data
  }).on('transactionHash', (hash) =&gt; {
    console.log(`Running Ethereum Trx: ${hash}`);
  });
}
</code></pre>
<p>Save the file, and all Eureka transactions should now execute with the new gas price value!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="under-the-hood"><a class="header" href="#under-the-hood">Under the Hood</a></h1>
<p>This section is intended to outline the Compound protocol deployment executions at a lower level. Instead of discussing the Eureka interface, the Ethereum transactions emitted by Eureka will be explored. This may be useful if you are looking to rewrite the Compound deployment scripts, as it will give you a sense of how to structure your code.</p>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<p><code>Compound Core</code> refers to the contracts deployed by Eureka when specifying the <code>compound.eureka</code> and <code>testnet.eureka</code> files in the <code>eureka</code> directory, and <code>Compound Core + Governance</code> refers to the contracts deployed by Eureka when specifying, in addition to the two former mentioned, <code>testnet-gov.eureka</code>.</p>
<h2 id="notation"><a class="header" href="#notation">Notation</a></h2>
<p><code>Order of Deployment</code> specifies the contracts deployed in order. Names in brackets refer to the actual contract name, and an arrow <code>---&gt;</code> designates the special relationship in which execution is delegated to another contract for implementation. In the only spot it is used, it is intended to show that the Unitroller delegates execution to ComptrollerG1.</p>
<p>Any number represented in scientific notation as <code>Number&lt;5e17&gt;</code> is loaned directly from Eureka and expands as expected, (e.g. as <code>500000000000000000</code>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-core"><a class="header" href="#compound-core">Compound Core</a></h1>
<p>The transactions outlined are the ones executed when specifying the <code>eureka/compound.eureka</code> and <code>eureka/testnet.eureka</code> files. They thus correspond to the command:</p>
<pre><code class="language-sh">yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet}.eureka
</code></pre>
<h2 id="order-of-deployment"><a class="header" href="#order-of-deployment">Order of Deployment</a></h2>
<ol>
<li>Compound Lens</li>
<li>Jump Rate Model</li>
<li>3x Whitepaper Interest Rate Models</li>
<li>ComptrollerG1</li>
<li>ComptrollerG2</li>
<li>CErc20Delegate</li>
<li>ERC-20 KNC</li>
<li>ERC-20 LINK</li>
<li>ERC-20 ZRX</li>
<li>ERC-20 WBTC [FaucetToken]</li>
<li>ERC-20 USDT</li>
<li>ERC-20 USDC [FaucetToken]</li>
<li>ERC-20 SAI [FaucetToken]</li>
<li>ERC-20 REP [FaucetToken]</li>
<li>ERC-20 DAI [FaucetToken]</li>
<li>ERC-20 BAT</li>
<li>Fauceteer</li>
<li>Simple Price Oracle</li>
<li>Unitroller [Unitroller ---&gt; ComptrollerG1]</li>
<li>CToken cZRX [CErc20Immutable]</li>
<li>CToken cWBTC [CErc20Immutable]</li>
<li>CToken cUSDT [CErc20Delegator]</li>
<li>CToken cUSDC [CErc20Immutable]</li>
<li>CToken cETH [CEther]</li>
<li>CToken cSAI [CErc20Immutable]</li>
<li>CToken cREP [CErc20Immutable]</li>
<li>CToken cDAI [CErc20Delegator]</li>
<li>CToken cBAT [CErc20Immutable]</li>
<li>Maximillion</li>
</ol>
<h2 id="constructors"><a class="header" href="#constructors">Constructors</a></h2>
<ol>
<li>
<p>Each <code>CToken</code> uses the underlying ERC-20 address, the Unitroller address, Interest Rate Model address, and an initial exchange rate. The <code>CErc20Delegator</code> tokens in particular set an implementation/delegate address to the address of the CErc20Delegate contract from earlier.</p>
</li>
<li>
<p>The <code>Maximillion</code> constructor simply receives the cETH address.</p>
</li>
</ol>
<h2 id="transaction-executions"><a class="header" href="#transaction-executions">Transaction Executions</a></h2>
<ul>
<li>
<p>After the USDT TetherToken is deployed, <code>TetherToken.issue()</code> is called with <code>5737970410e6</code> being the argument (issuing that many tokens to the owner).</p>
</li>
<li>
<p>After the <code>SimplePriceOracle</code> is deployed, each of the ERC-20 tokens are set to a proper price: for example, BAT is set to &quot;base: 67126, exp: 10&quot;, translating to:</p>
<ul>
<li>SimplePriceOracle.setDirectPrice(address of BAT, 671260000000000)</li>
<li>Note that the contract is first deployed, before sending a transaction to set each underlying price</li>
</ul>
</li>
<li>
<p>After the <code>Unitroller</code> is deployed, the following transactions are executed:</p>
<ul>
<li>Unitroller._setPendingImplementation(address of ComptrollerG1)</li>
<li>ComptrollerG1._become(Unitroller, SimplePriceOracle, Number&lt;5e17&gt;, Number&lt;20e0&gt;, false)</li>
<li>Unitroller._setPriceOracle(address of SimplePriceOracle)</li>
<li>Unitroller._setMaxAssets(Number&lt;20e0&gt;)</li>
<li>Unitroller._setCloseFactor(Number&lt;5e17&gt;)</li>
</ul>
</li>
<li>
<p>After the CTokens have been deployed, a transaction is run, for each ERC-20, to transfer a high number of tokens from the current deployer (i.e. <code>msg.sender</code>) to the Fauceteer contract address</p>
</li>
<li>
<p>After the Fauceteer has received all tokens, the Unitroller is called to support each cToken market and to set each collateral factor. An example with cBAT:</p>
<ul>
<li>Unitroller._supportMarket(address of cBAT)</li>
<li>Unitroller._setCollateralFactor(address of cBAT, 600000000000000000)</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-core--governance"><a class="header" href="#compound-core--governance">Compound Core + Governance</a></h1>
<p>The transactions outlined are the ones executed when specifying the <code>eureka/compound.eureka</code>, ,<code>eureka/testnet.eureka</code>, and <code>eureka/testnet-gov.eureka</code> files. They thus correspond to the command:</p>
<pre><code class="language-sh">yarn eureka apply -n ropsten -b ./.build -c config/*.js -e eureka/{compound,testnet,testnet-gov}.eureka
</code></pre>
<h2 id="order-of-deployment-1"><a class="header" href="#order-of-deployment-1">Order of Deployment</a></h2>
<ol>
<li>Compound Lens</li>
<li>Jump Rate Model</li>
<li>3x Whitepaper Interest Rate Models</li>
<li>ComptrollerG2</li>
<li>ComptrollerG1</li>
<li>CErc20Delegate</li>
<li>ERC-20 KNC</li>
<li>ERC-20 LINK</li>
<li>ERC-20 ZRX</li>
<li>ERC-20 WBTC [FaucetToken]</li>
<li>ERC-20 USDT</li>
<li>ERC-20 USDC [FaucetToken]</li>
<li>ERC-20 SAI [FaucetToken]</li>
<li>ERC-20 REP [FaucetToken]</li>
<li>ERC-20 DAI [FaucetToken]</li>
<li>ERC-20 BAT</li>
<li>Fauceteer</li>
<li>Simple Price Oracle</li>
<li>ERC-20 Comp [Comp]</li>
<li>TimelockTest</li>
<li>Unitroller [Unitroller ---&gt; ComptrollerG1]</li>
<li>CToken cZRX [CErc20Immutable]</li>
<li>CToken cWBTC [CErc20Immutable]</li>
<li>CToken cUSDT [CErc20Delegator]</li>
<li>CToken cUSDC [CErc20Immutable]</li>
<li>CToken cETH [CEther]</li>
<li>CToken cSAI [CErc20Immutable]</li>
<li>CToken cREP [CErc20Immutable]</li>
<li>CToken cDAI [CErc20Delegator]</li>
<li>CToken cBAT [CErc20Immutable]</li>
<li>Reservoir</li>
<li>GovernorAlphaHarness</li>
<li>Maximillion</li>
</ol>
<h2 id="constructors-1"><a class="header" href="#constructors-1">Constructors</a></h2>
<ol>
<li>
<p>The <code>Comp</code> constructor receives an account which to grant the inital supply to, in which case is set to the sender (i.e. the deployer).</p>
</li>
<li>
<p>The <code>TimelockTest</code> constructor is passed the sender (i.e. deployer) address as the admin, and <code>60e0</code> (i.e. 60) as the delay.</p>
</li>
<li>
<p>Each <code>CToken</code> uses the underlying ERC-20 address, the Unitroller address, Interest Rate Model address, and an initial exchange rate. The <code>CErc20Delegator</code> tokens in particular set an implementation/delegate address to the address of the CErc20Delegate contract from earlier.</p>
</li>
<li>
<p>The <code>Reservoir</code> constructor receives the number of tokens to drip per block (in this case, being <code>Number&lt;5e17&gt;</code>), the token to drip (Comp), and the address to drip to (the Unitroller address).</p>
</li>
<li>
<p>The <code>GovernorAlphaHarness</code> constructor is passed the TimelockTest contract address, the Comp contract address, and the sender (i.e. the deployer) address as the guardian.</p>
</li>
<li>
<p>The <code>Maximillion</code> constructor simply receives the cETH address.</p>
</li>
</ol>
<h2 id="transaction-executions-1"><a class="header" href="#transaction-executions-1">Transaction Executions</a></h2>
<ul>
<li>
<p>After the USDT TetherToken is deployed, <code>TetherToken.issue()</code> is called with <code>Number&lt;5737970410e6&gt;</code> being the argument (issuing that many tokens to the owner).</p>
</li>
<li>
<p>After the <code>SimplePriceOracle</code> is deployed, each of the ERC-20 tokens are set to a proper price: for example, BAT is set to &quot;base: 67126, exp: 10&quot;, translating to:</p>
<ul>
<li>SimplePriceOracle.setDirectPrice(address of BAT, 671260000000000)</li>
<li>Note that the contract is first deployed, before sending a transaction to set each underlying price</li>
</ul>
</li>
<li>
<p>After the <code>Comp</code> token is deployed, the delegator for the deployer is set to the deployer address, translating to:</p>
<ul>
<li>Comp.delegate(address of deployer)</li>
</ul>
</li>
<li>
<p>After the <code>Unitroller</code> is deployed, the following transactions are executed:</p>
<ul>
<li>Unitroller._setPendingImplementation(address of ComptrollerG1)</li>
<li>ComptrollerG1._become(Unitroller, SimplePriceOracle, Number&lt;5e17&gt;, Number&lt;20e0&gt;, false)</li>
<li>Unitroller._setPriceOracle(address of SimplePriceOracle)</li>
<li>Unitroller._setMaxAssets(Number&lt;20e0&gt;)</li>
<li>Unitroller._setCloseFactor(Number&lt;5e17&gt;)</li>
</ul>
</li>
<li>
<p>After the CTokens have been deployed, a transaction is run, for each ERC-20, to transfer a high number of tokens from the current deployer (i.e. <code>msg.sender</code>) to the Fauceteer contract address</p>
<ul>
<li>Each are generally [ERC-20].transfer(address of Fauceteer, amount)</li>
</ul>
</li>
<li>
<p>After the <code>Reservoir</code> is deployed, two transfers are executed on the Comp ERC-20: </p>
<ul>
<li><code>1e24</code> to the Fauceteer as Comp.transfer(address of Fauceteer, 1e24)</li>
<li><code>4e24</code> to the Reservoir as Comp.transfer(address of Reservoir, 4e24)</li>
</ul>
</li>
<li>
<p>After the <code>GovernorAlphaHarness</code> is deployed, the admin of the TimeLockTest is set to the address of the <code>GovernorAlphaHarness</code>:</p>
<ul>
<li>TimelockTest.harnessSetAdmin(address of GovernorAlphaHarness)</li>
</ul>
</li>
<li>
<p>After the TimelockTest.harnessSetAdmin() send transaction, the Unitroller is called to support each cToken market and to set each collateral factor. An example with cBAT:</p>
<ul>
<li>Unitroller._supportMarket(address of cBAT)</li>
<li>Unitroller._setCollateralFactor(address of cBAT, 600000000000000000)</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<p>This section covers problems that may occur during the process of building or deploying Compound protocol smart contracts. If you've run into an error trying some of the commands in previous sections, I would suggest you look for your encountered error here!</p>
<h2 id="compound-protocol-1"><a class="header" href="#compound-protocol-1">compound-protocol</a></h2>
<ul>
<li><a href="troubleshooting/./compound-protocol.html#unknown-option-p"><code>Unknown option: p</code></a></li>
<li><a href="troubleshooting/./compound-protocol.html#error-source-file-requires-different-compiler-version-current-compiler-is-xxxcommitxxxxxxxxxxxxxx"><code>Error: Source file requires different compiler version (current compiler is x.x.x+commit.xxxxxxxx.xxx.xxx)</code></a></li>
<li><a href="troubleshooting/./compound-protocol.html#typeerror-objectfromentries-is-not-a-function"><code>TypeError: Object.fromEntries is not a function</code></a></li>
<li><a href="troubleshooting/./compound-protocol.html#libusblibusboslinux_udevc4010-fatal-error-libudevh-no-such-file-or-directory"><code>../libusb/libusb/os/linux_udev.c:40:10: fatal error: libudev.h: No such file or directory</code></a></li>
<li><a href="troubleshooting/./compound-protocol.html#error-callback-was-already-called"><code>Error: Callback was already called</code></a></li>
</ul>
<h2 id="compound-eureka"><a class="header" href="#compound-eureka">compound-eureka</a></h2>
<ul>
<li><a href="troubleshooting/./compound-eureka.html#transaction-timeout"><code>Transaction timeout</code></a></li>
<li><a href="troubleshooting/./compound-eureka.html#yarn-eureka-apply-breaks-partway"><code>yarn eureka apply</code> breaks partway</a></li>
<li><a href="troubleshooting/./compound-eureka.html#general-failsafe">General Failsafe</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-protocol-2"><a class="header" href="#compound-protocol-2">compound-protocol</a></h1>
<h2 id="unknown-option-p"><a class="header" href="#unknown-option-p"><code>Unknown option: p</code></a></h2>
<p>When running one of the package scripts, like <code>yarn test</code>, the output errors and stops, displaying:</p>
<pre><code>Unknown option: p
Type shasum -h for help
Unknown option: p
Type shasum -h for help
error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
</code></pre>
<p>As of the commit written to this guide, this fix has been merged as of <a href="https://github.com/compound-finance/compound-protocol/commit/eb7a6c9831198a19736bc4c1f8f66d41b98f4eaf">eb7a6c9</a>, but as the error appeared during the writing of this guide, it will be mentioned. Chances are, if you have this error, you have checked out an earlier commit of Compound protocol.</p>
<p>To fix this error which is relevant to a newer version of <code>shasum</code>, make the changes to the files described in this pull request: <a href="https://github.com/compound-finance/compound-protocol/pull/80/files">https://github.com/compound-finance/compound-protocol/pull/80/files</a>.</p>
<h2 id="error-source-file-requires-different-compiler-version-current-compiler-is-xxxcommitxxxxxxxxxxxxxx"><a class="header" href="#error-source-file-requires-different-compiler-version-current-compiler-is-xxxcommitxxxxxxxxxxxxxx"><code>Error: Source file requires different compiler version (current compiler is x.x.x+commit.xxxxxxxx.xxx.xxx)</code></a></h2>
<p><code>solc</code> v0.5.16+ is required to compile the current smart contracts. The solution is to install that version of <code>solc</code> to your computer. To install, please see the <a href="troubleshooting/../getting-started/installation.html#solc-v0516">Installation section on solc</a>.</p>
<h2 id="typeerror-objectfromentries-is-not-a-function"><a class="header" href="#typeerror-objectfromentries-is-not-a-function"><code>TypeError: Object.fromEntries is not a function</code></a></h2>
<p>If you're getting this error, you are likely on an older version of node (check <code>node -v</code>). Chances are, you have installed node from the <code>apt</code> package manager, which installs Node 10.x. Due to the requirement of a version of Node below 14+ for <code>compound-eureka</code>, I recommend that you install Node 13.x. To install, please see the <a href="troubleshooting/../getting-started/installation.html#node-13x">Installation section on Node</a>.</p>
<h2 id="libusblibusboslinux_udevc4010-fatal-error-libudevh-no-such-file-or-directory"><a class="header" href="#libusblibusboslinux_udevc4010-fatal-error-libudevh-no-such-file-or-directory"><code>../libusb/libusb/os/linux_udev.c:40:10: fatal error: libudev.h: No such file or directory</code></a></h2>
<p>This error may appear when installing packages in the initial setup phase. The full error output may look like:</p>
<pre><code class="language-sh">root@ubuntu-s-2vcpu-4gb-intel-tor1-01:~/compound-protocol# yarn install --lock-file
yarn install v1.22.11
[1/4] Resolving packages...
[2/4] Fetching packages...
info fsevents@1.2.11: The platform &quot;linux&quot; is incompatible with this module.
info &quot;fsevents@1.2.11&quot; is an optional dependency and failed compatibility check. Excluding it from installation.
info fsevents@2.1.2: The platform &quot;linux&quot; is incompatible with this module.
info &quot;fsevents@2.1.2&quot; is an optional dependency and failed compatibility check. Excluding it from installation.
[3/4] Linking dependencies...
warning &quot;eth-saddle &gt; web3-provider-engine &gt; eth-block-tracker &gt; @babel/plugin-transform-runtime@7.8.3&quot; has unmet peer dependency &quot;@babel/core@^7.0.0-0&quot;.
[4/4] Building fresh packages...
[11/32]  usb
[10/32]  node-hid
[3/32]  sha3
[4/32]  keccak
warning Error running install script for optional dependency: &quot;/root/compound-protocol/node_modules/node-hid: Command failed.
Exit code: 1
Command: prebuild-install || node-gyp rebuild
Arguments:
Directory: /root/compound-protocol/node_modules/node-hid
Output:
prebuild-install WARN install No prebuilt binaries found (target=14.17.4 runtime=node arch=x64 libc= platform=linux)
gyp info it worked if it ends with ok
gyp info using node-gyp@5.1.0
gyp info using node@14.17.4 | linux | x64
gyp info find Python using Python version 3.8.5 found at \&quot;/usr/bin/python3\&quot;
gyp info spawn /usr/bin/python3
gyp info spawn args [
gyp info spawn args   '/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py',
gyp info spawn args   'binding.gyp',
gyp info spawn args   '-f',
gyp info spawn args   'make',
gyp info spawn args   '-I',
gyp info spawn args   '/root/compound-protocol/node_modules/node-hid/build/config.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/usr/lib/node_modules/npm/node_modules/node-gyp/addon.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/root/.cache/node-gyp/14.17.4/include/node/common.gypi',
gyp info spawn args   '-Dlibrary=shared_library',
gyp info spawn args   '-Dvisibility=default',
gyp info spawn args   '-Dnode_root_dir=/root/.cache/node-gyp/14.17.4',
gyp info spawn args   '-Dnode_gyp_dir=/usr/lib/node_modules/npm/node_modules/node-gyp',
gyp info spawn args   '-Dnode_lib_file=/root/.cache/node-gyp/14.17.4/&lt;(target_arch)/node.lib',
gyp info spawn args   '-Dmodule_root_dir=/root/compound-protocol/node_modules/node-hid',
gyp info spawn args   '-Dnode_engine=v8',
gyp info spawn args   '--depth=.',
gyp info spawn args   '--no-parallel',
gyp info spawn args   '--generator-output',
gyp info spawn args   'build',
gyp info spawn args   '-Goutput_dir=.'
gyp info spawn args ]
gyp info spawn make
gyp info spawn args [ 'BUILDTYPE=Release', '-C', 'build' ]
make: Entering directory '/root/compound-protocol/node_modules/node-hid/build'
  CC(target) Release/obj.target/hidapi-linux-hidraw/hidapi/linux/hid.o
../hidapi/linux/hid.c:44:10: fatal error: libudev.h: No such file or directory
   44 | #include &lt;libudev.h&gt;
      |          ^~~~~~~~~~~
compilation terminated.
make: *** [hidapi-linux-hidraw.target.mk:111: Release/obj.target/hidapi-linux-hidraw/hidapi/linux/hid.o] Error 1
make: Leaving directory '/root/compound-protocol/node_modules/node-hid/build'
gyp ERR! build error
gyp ERR! stack Error: `make` failed with exit code: 2
gyp ERR! stack     at ChildProcess.onExit (/usr/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:194:23)
gyp ERR! stack     at ChildProcess.emit (events.js:400:28)
gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:277:12)
gyp ERR! System Linux 5.4.0-73-generic
gyp ERR! command \&quot;/usr/bin/node\&quot; \&quot;/usr/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\&quot; \&quot;rebuild\&quot;
gyp ERR! cwd /root/compound-protocol/node_modules/node-hid
[11/32]  usb
[12/32]  websocket
[-/32]  waiting...
[-/32]  waiting...
warning Error running install script for optional dependency: &quot;/root/compound-protocol/node_modules/usb: Command failed.
Exit code: 1
Command: prebuild-install --verbose || node-gyp rebuild
Arguments:
Directory: /root/compound-protocol/node_modules/usb
Output:
prebuild-install info begin Prebuild-install version 5.3.3
prebuild-install info looking for cached prebuild @ /root/.npm/_prebuilds/f28b5a-usb-v1.6.2-node-v83-linux-x64.tar.gz
prebuild-install http request GET https://github.com/tessel/node-usb/releases/download/v1.6.2/usb-v1.6.2-node-v83-linux-x64.tar.gz
prebuild-install http 404 https://github.com/tessel/node-usb/releases/download/v1.6.2/usb-v1.6.2-node-v83-linux-x64.tar.gz
prebuild-install WARN install No prebuilt binaries found (target=14.17.4 runtime=node arch=x64 libc= platform=linux)
gyp info it worked if it ends with ok
gyp info using node-gyp@5.1.0
gyp info using node@14.17.4 | linux | x64
gyp info find Python using Python version 3.8.5 found at \&quot;/usr/bin/python3\&quot;
gyp info spawn /usr/bin/python3
gyp info spawn args [
gyp info spawn args   '/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py',
gyp info spawn args   'binding.gyp',
gyp info spawn args   '-f',
gyp info spawn args   'make',
gyp info spawn args   '-I',
gyp info spawn args   '/root/compound-protocol/node_modules/usb/build/config.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/usr/lib/node_modules/npm/node_modules/node-gyp/addon.gypi',
gyp info spawn args   '-I',
gyp info spawn args   '/root/.cache/node-gyp/14.17.4/include/node/common.gypi',
gyp info spawn args   '-Dlibrary=shared_library',
gyp info spawn args   '-Dvisibility=default',
gyp info spawn args   '-Dnode_root_dir=/root/.cache/node-gyp/14.17.4',
gyp info spawn args   '-Dnode_gyp_dir=/usr/lib/node_modules/npm/node_modules/node-gyp',
gyp info spawn args   '-Dnode_lib_file=/root/.cache/node-gyp/14.17.4/&lt;(target_arch)/node.lib',
gyp info spawn args   '-Dmodule_root_dir=/root/compound-protocol/node_modules/usb',
gyp info spawn args   '-Dnode_engine=v8',
gyp info spawn args   '--depth=.',
gyp info spawn args   '--no-parallel',
gyp info spawn args   '--generator-output',
gyp info spawn args   'build',
gyp info spawn args   '-Goutput_dir=.'
gyp info spawn args ]
gyp info spawn make
gyp info spawn args [ 'BUILDTYPE=Release', '-C', 'build' ]
make: Entering directory '/root/compound-protocol/node_modules/usb/build'
  CC(target) Release/obj.target/libusb/libusb/libusb/core.o
  CC(target) Release/obj.target/libusb/libusb/libusb/descriptor.o
  CC(target) Release/obj.target/libusb/libusb/libusb/hotplug.o
  CC(target) Release/obj.target/libusb/libusb/libusb/io.o
  CC(target) Release/obj.target/libusb/libusb/libusb/strerror.o
  CC(target) Release/obj.target/libusb/libusb/libusb/sync.o
  CC(target) Release/obj.target/libusb/libusb/libusb/os/poll_posix.o
  CC(target) Release/obj.target/libusb/libusb/libusb/os/threads_posix.o
  CC(target) Release/obj.target/libusb/libusb/libusb/os/linux_usbfs.o
  CC(target) Release/obj.target/libusb/libusb/libusb/os/linux_udev.o
../libusb/libusb/os/linux_udev.c:40:10: fatal error: libudev.h: No such file or directory
   40 | #include &lt;libudev.h&gt;
      |          ^~~~~~~~~~~
compilation terminated.
make: *** [libusb.target.mk:150: Release/obj.target/libusb/libusb/libusb/os/linux_udev.o] Error 1
make: Leaving directory '/root/compound-protocol/node_modules/usb/build'
gyp ERR! build error
gyp ERR! stack Error: `make` failed with exit code: 2
gyp ERR! stack     at ChildProcess.onExit (/usr/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:194:23)
gyp ERR! stack     at ChildProcess.emit (events.js:400:28)
gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:277:12)
gyp ERR! System Linux 5.4.0-73-generic
gyp ERR! command \&quot;/usr/bin/node\&quot; \&quot;/usr/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\&quot; \&quot;rebuild\&quot;
gyp ERR! cwd /root/compound-protocol/node_modules/usb
Done in 55.61s.
</code></pre>
<p>What you will want to do is to make sure <code>libusb</code> and <code>libudev</code> are installed. To install them and fix the error, please see the <a href="troubleshooting/../getting-started/installation.html#libusb-and-libudev">Installation section on libusb and libudev</a>.</p>
<p><strong>NOTE</strong>: If you have run a command that invokes this error, it is expected for the command to display this error at least once after installing, so don't worry if you see it again! Simply try the command again, and it should run successfully.</p>
<h2 id="error-callback-was-already-called"><a class="header" href="#error-callback-was-already-called"><code>Error: Callback was already called</code></a></h2>
<p>This error occurs with Node 14+. To solve, install an earlier version of Node, preferably Node 13.x. To install, please see the <a href="troubleshooting/../getting-started/installation.html#node-13x">Installation section on Node</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compound-eureka-1"><a class="header" href="#compound-eureka-1">compound-eureka</a></h1>
<h2 id="transaction-timeout"><a class="header" href="#transaction-timeout"><code>Transaction timeout</code></a></h2>
<p>This can occur if the transaction fails to confirm on time during the script. To prevent this, you can <a href="troubleshooting/../deploy-compound/tips.html#increasing-gas-price">increase the gas price manually</a>.</p>
<h2 id="yarn-eureka-apply-breaks-partway"><a class="header" href="#yarn-eureka-apply-breaks-partway"><code>yarn eureka apply</code> breaks partway</a></h2>
<p>Sometimes when deploying, <code>yarn eureka apply</code> will break partway through deployment with an error such as <code>Error: Returned error: nonce too low</code>, or an assertion breaking, or something else entirely. <code>compound-eureka</code> is still buggy, and the errors tend to suggest that Eureka sends a transaction too soon: the previous one has not finished resolving/confirming, so the call to web3.js produces a transaction with a nonce that is too low, or a state which has not finished updating from the last transaction.</p>
<p>Typically when it breaks like this, you are given the option to save to state. You may save the deployment data to state and try to run the deployment again, and observe where it picks up; sometimes, it may skip some steps when starting again, so it is often safer to clean the state and start again. </p>
<p>This is unfortunately a bug in Eureka that has to be worked around. <a href="troubleshooting/../deploy-compound/tips.html#increasing-gas-price">Setting the gas price manually</a> is one way to attempt to avoid this error. </p>
<p>If the recurrent breaking is too difficult to tolerate, you can also attempt to write a deployment script yourself. It may help to look at the <a href="troubleshooting/../under-the-hood">Under the Hood</a> section to learn about the low-level executions ran by Eureka.</p>
<h2 id="general-failsafe"><a class="header" href="#general-failsafe">General Failsafe</a></h2>
<p>Any other issues may be fixed by <a href="troubleshooting/../deploy-compound/tips.html#cleaning-deployment-state">cleaning the repo of the state file</a>, which will allow Eureka to run fresh.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="credits"><a class="header" href="#credits">Credits</a></h1>
<p><a href="https://github.com/Luiserebii"><img src="./img/l1.gif" style="border-radius:50%"/></a></p>
<p>This guide has been written by <a href="https://github.com/Luiserebii">Luiserebii</a> for the <a href="https://gitcoin.co/issue/0xSvengali/Docs/1/100026174">Compound Docs Gitcoin bounty by 0xSvengali</a>. </p>
<p>Thanks for reading! If you run into any issues unaddressed by the guide, feel free to open a pull request on the <a href="https://github.com/Luiserebii/compound-protocol-docs">GitHub repository for the guide</a>, or contact me at <a href="mailto:luis@serebii.io">luis@serebii.io</a>!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
